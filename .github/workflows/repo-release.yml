name: Repository Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      releaseTag:
        description: "Release version/tag (vX.Y.Z or X.Y.Z)"
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name || inputs.releaseTag }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Resolve release metadata
        id: meta
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            raw_tag="${{ inputs.releaseTag }}"
          else
            raw_tag="${GITHUB_REF_NAME}"
          fi

          if [[ ! "$raw_tag" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid release tag/version '$raw_tag' (expected vX.Y.Z or X.Y.Z)"
            exit 1
          fi

          semver="${raw_tag#v}"
          tag="v${semver}"
          major_tag="v${semver%%.*}"

          {
            printf 'tag=%s\n' "$tag"
            printf 'major_tag=%s\n' "$major_tag"
          } >> "$GITHUB_OUTPUT"

      - name: Ensure release tag exists (or create for manual run)
        shell: bash
        run: |
          tag="${{ steps.meta.outputs.tag }}"
          git fetch --force --tags origin

          if git rev-parse "$tag^{commit}" >/dev/null 2>&1; then
            echo "Tag '$tag' already exists"
            exit 0
          fi

          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            echo "::error::Tag '$tag' does not exist in repository"
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git tag "$tag" "$GITHUB_SHA"
          git push origin "refs/tags/$tag"

          echo "Created tag '$tag' at commit '$GITHUB_SHA'"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          tag="${{ steps.meta.outputs.tag }}"

          if gh release view "$tag" >/dev/null 2>&1; then
            echo "Release '$tag' already exists, skipping creation"
          else
            gh release create "$tag" \
              --verify-tag \
              --generate-notes \
              --title "$tag"
          fi

      - name: Move major version tag
        shell: bash
        run: |
          tag="${{ steps.meta.outputs.tag }}"
          major_tag="${{ steps.meta.outputs.major_tag }}"

          git fetch --force --tags origin
          git tag -f "$major_tag" "$tag"
          git push origin "refs/tags/$major_tag" --force

          echo "Updated $major_tag -> $tag"
