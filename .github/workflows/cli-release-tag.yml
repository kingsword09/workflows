name: Reusable CLI Release (Tag)

on:
  workflow_call:
    inputs:
      packageManager:
        description: "npm | pnpm | yarn | bun | deno"
        required: true
        type: string
      environment:
        description: "Optional GitHub Environment name (enables environment protections/secrets)"
        required: false
        type: string
        default: ""
      workingDirectory:
        description: "Working directory of the package"
        required: false
        type: string
        default: "."
      nodeVersion:
        description: "Node.js version (ignored for deno)"
        required: false
        type: string
        default: "20"
      denoVersion:
        description: "Deno version (only for deno)"
        required: false
        type: string
        default: "v2.x"
      releaseTag:
        description: "Override tag name (e.g. v1.2.3). If empty, derives from github ref (refs/tags/*)"
        required: false
        type: string
        default: ""
      validateVersion:
        description: "Validate package version matches the tag version"
        required: false
        type: boolean
        default: true
      updateNpm:
        description: "Update npm to latest before publishing (Node package managers only)"
        required: false
        type: boolean
        default: true
      trustedPublishing:
        description: "Use npm Trusted Publishing (OIDC) for npm publish (no NPM_TOKEN required; non-deno only)"
        required: false
        type: boolean
        default: false
      installCommand:
        description: "Override install command"
        required: false
        type: string
        default: ""
      buildCommand:
        description: "Override build command (empty = auto: skip if prepublishOnly/prepack exists, else run default)"
        required: false
        type: string
        default: ""
      publishCommand:
        description: "Override publish command"
        required: false
        type: string
        default: ""
      changelogCommand:
        description: "Override changelog/release command (empty to skip)"
        required: false
        type: string
        default: ""
    secrets:
      NPM_TOKEN:
        required: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    if: inputs.environment == ''
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          fetch-depth: 0

      - name: Resolve release tag
        id: tag
        shell: bash
        run: |
          tag_input="${{ inputs.releaseTag }}"
          if [[ -n "$tag_input" ]]; then
            tag="$tag_input"
          else
            ref="${GITHUB_REF}"
            if [[ "$ref" == refs/tags/* ]]; then
              tag="${ref#refs/tags/}"
            else
              echo "::error::Not running on a tag. Trigger your caller workflow on tag push, or set inputs.releaseTag."
              exit 1
            fi
          fi

          if [[ "$tag" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            semver="${tag#v}"
          else
            echo "::error::Invalid tag: '$tag' (expected vX.Y.Z)"
            exit 1
          fi

          printf 'tag=v%s\nversion=%s\n' "$semver" "$semver" >> "$GITHUB_OUTPUT"
          echo "Release tag: v$semver"

      - name: Setup Node.js
        if: inputs.packageManager != 'deno'
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: ${{ inputs.nodeVersion }}
          registry-url: "https://registry.npmjs.org"

      - name: Enable Corepack
        if: inputs.packageManager == 'pnpm' || inputs.packageManager == 'yarn'
        shell: bash
        run: corepack enable

      - name: Setup Bun
        if: inputs.packageManager == 'bun'
        uses: oven-sh/setup-bun@f4d14e03ff726c06358e5557344e1da148b56cf7 # v1

      - name: Setup Deno
        if: inputs.packageManager == 'deno'
        uses: denoland/setup-deno@11b63cf76cfcafb4e43f97b6cad24d8e8438f62d # v1.5.2
        with:
          deno-version: ${{ inputs.denoVersion }}

      - name: Resolve commands
        id: cmds
        shell: bash
        run: |
          pm="${{ inputs.packageManager }}"
          wd="${{ inputs.workingDirectory }}"

          install="${{ inputs.installCommand }}"
          build="${{ inputs.buildCommand }}"
          publish="${{ inputs.publishCommand }}"
          changelog="${{ inputs.changelogCommand }}"

          if [[ -z "$install" ]]; then
            case "$pm" in
              npm) install="npm ci" ;;
              pnpm) install="pnpm install --frozen-lockfile" ;;
              yarn)
                if [[ -f ".yarnrc.yml" || -d ".yarn" ]]; then
                  install="yarn install --immutable"
                else
                  install="yarn install --frozen-lockfile"
                fi
                ;;
              bun) install="bun install --frozen-lockfile" ;;
              deno) install="" ;;
              *)
                echo "::error::Unsupported packageManager: $pm"
                exit 1
                ;;
            esac
          fi

          if [[ -z "$build" ]]; then
            if [[ "$pm" == "deno" ]]; then
              build="deno task build"
            else
              if node -e "const s=require('./${wd}/package.json').scripts||{}; process.exit((s.prepublishOnly||s.prepack)?0:1)"; then
                echo "Detected prepublishOnly/prepack; skipping explicit build step"
                build=""
              else
                case "$pm" in
                  npm) build="npm run build" ;;
                  pnpm) build="pnpm run build" ;;
                  yarn) build="yarn build" ;;
                  bun) build="bun run build" ;;
                  *) exit 1 ;;
                esac
              fi
            fi
          fi

          if [[ -z "$publish" ]]; then
            case "$pm" in
              npm|pnpm|yarn|bun) publish="npm publish --access public" ;;
              deno) publish="deno publish" ;;
              *) exit 1 ;;
            esac
          fi

          if [[ -z "$changelog" ]]; then
            case "$pm" in
              bun) changelog="bunx --bun changelogithub" ;;
              npm|pnpm|yarn) changelog="npx changelogithub" ;;
              deno) changelog="" ;;
              *) exit 1 ;;
            esac
          fi

          {
            printf 'install=%s\n' "$install"
            printf 'build=%s\n' "$build"
            printf 'publish=%s\n' "$publish"
            printf 'changelog=%s\n' "$changelog"
          } >> "$GITHUB_OUTPUT"

      - name: Validate version
        if: inputs.packageManager != 'deno' && inputs.validateVersion
        working-directory: ${{ inputs.workingDirectory }}
        shell: bash
        run: |
          VERSION="${{ steps.tag.outputs.version }}"
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [ "${PKG_VERSION}" != "${VERSION}" ]; then
            echo "::error::Version mismatch: tag is v${VERSION} but package.json has v${PKG_VERSION}"
            exit 1
          fi
          echo "Version validated: v${VERSION}"

      - name: Install dependencies
        if: steps.cmds.outputs.install != ''
        working-directory: ${{ inputs.workingDirectory }}
        run: ${{ steps.cmds.outputs.install }}

      - name: Build
        if: steps.cmds.outputs.build != ''
        working-directory: ${{ inputs.workingDirectory }}
        run: ${{ steps.cmds.outputs.build }}

      - name: Update npm
        if: inputs.packageManager != 'deno' && (inputs.updateNpm || inputs.trustedPublishing)
        run: npm install -g npm@latest

      - name: Validate NPM_TOKEN
        if: inputs.packageManager != 'deno' && !inputs.trustedPublishing
        shell: bash
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [[ -z "${NPM_TOKEN}" ]]; then
            echo "::error::Missing required secret NPM_TOKEN for npm publish"
            exit 1
          fi

      - name: Publish (npm token)
        if: inputs.packageManager != 'deno' && !inputs.trustedPublishing
        working-directory: ${{ inputs.workingDirectory }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: ${{ steps.cmds.outputs.publish }}

      - name: Publish (trusted publishing)
        if: inputs.packageManager != 'deno' && inputs.trustedPublishing
        working-directory: ${{ inputs.workingDirectory }}
        run: ${{ steps.cmds.outputs.publish }}

      - name: Publish (deno)
        if: inputs.packageManager == 'deno'
        working-directory: ${{ inputs.workingDirectory }}
        run: ${{ steps.cmds.outputs.publish }}

      - name: Generate changelog and create release
        if: steps.cmds.outputs.changelog != ''
        working-directory: ${{ inputs.workingDirectory }}
        run: ${{ steps.cmds.outputs.changelog }}
        env:
          GITHUB_TOKEN: ${{ github.token }}

  release_with_environment:
    if: inputs.environment != ''
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          fetch-depth: 0

      - name: Resolve release tag
        id: tag
        shell: bash
        run: |
          tag_input="${{ inputs.releaseTag }}"
          if [[ -n "$tag_input" ]]; then
            tag="$tag_input"
          else
            ref="${GITHUB_REF}"
            if [[ "$ref" == refs/tags/* ]]; then
              tag="${ref#refs/tags/}"
            else
              echo "::error::Not running on a tag. Trigger your caller workflow on tag push, or set inputs.releaseTag."
              exit 1
            fi
          fi

          if [[ "$tag" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            semver="${tag#v}"
          else
            echo "::error::Invalid tag: '$tag' (expected vX.Y.Z)"
            exit 1
          fi

          printf 'tag=v%s\nversion=%s\n' "$semver" "$semver" >> "$GITHUB_OUTPUT"
          echo "Release tag: v$semver"

      - name: Setup Node.js
        if: inputs.packageManager != 'deno'
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: ${{ inputs.nodeVersion }}
          registry-url: "https://registry.npmjs.org"

      - name: Enable Corepack
        if: inputs.packageManager == 'pnpm' || inputs.packageManager == 'yarn'
        shell: bash
        run: corepack enable

      - name: Setup Bun
        if: inputs.packageManager == 'bun'
        uses: oven-sh/setup-bun@f4d14e03ff726c06358e5557344e1da148b56cf7 # v1

      - name: Setup Deno
        if: inputs.packageManager == 'deno'
        uses: denoland/setup-deno@11b63cf76cfcafb4e43f97b6cad24d8e8438f62d # v1.5.2
        with:
          deno-version: ${{ inputs.denoVersion }}

      - name: Resolve commands
        id: cmds
        shell: bash
        run: |
          pm="${{ inputs.packageManager }}"
          wd="${{ inputs.workingDirectory }}"

          install="${{ inputs.installCommand }}"
          build="${{ inputs.buildCommand }}"
          publish="${{ inputs.publishCommand }}"
          changelog="${{ inputs.changelogCommand }}"

          if [[ -z "$install" ]]; then
            case "$pm" in
              npm) install="npm ci" ;;
              pnpm) install="pnpm install --frozen-lockfile" ;;
              yarn)
                if [[ -f ".yarnrc.yml" || -d ".yarn" ]]; then
                  install="yarn install --immutable"
                else
                  install="yarn install --frozen-lockfile"
                fi
                ;;
              bun) install="bun install --frozen-lockfile" ;;
              deno) install="" ;;
              *)
                echo "::error::Unsupported packageManager: $pm"
                exit 1
                ;;
            esac
          fi

          if [[ -z "$build" ]]; then
            if [[ "$pm" == "deno" ]]; then
              build="deno task build"
            else
              if node -e "const s=require('./${wd}/package.json').scripts||{}; process.exit((s.prepublishOnly||s.prepack)?0:1)"; then
                echo "Detected prepublishOnly/prepack; skipping explicit build step"
                build=""
              else
                case "$pm" in
                  npm) build="npm run build" ;;
                  pnpm) build="pnpm run build" ;;
                  yarn) build="yarn build" ;;
                  bun) build="bun run build" ;;
                  *) exit 1 ;;
                esac
              fi
            fi
          fi

          if [[ -z "$publish" ]]; then
            case "$pm" in
              npm|pnpm|yarn|bun) publish="npm publish --access public" ;;
              deno) publish="deno publish" ;;
              *) exit 1 ;;
            esac
          fi

          if [[ -z "$changelog" ]]; then
            case "$pm" in
              bun) changelog="bunx --bun changelogithub" ;;
              npm|pnpm|yarn) changelog="npx changelogithub" ;;
              deno) changelog="" ;;
              *) exit 1 ;;
            esac
          fi

          {
            printf 'install=%s\n' "$install"
            printf 'build=%s\n' "$build"
            printf 'publish=%s\n' "$publish"
            printf 'changelog=%s\n' "$changelog"
          } >> "$GITHUB_OUTPUT"

      - name: Validate version
        if: inputs.packageManager != 'deno' && inputs.validateVersion
        working-directory: ${{ inputs.workingDirectory }}
        shell: bash
        run: |
          VERSION="${{ steps.tag.outputs.version }}"
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [ "${PKG_VERSION}" != "${VERSION}" ]; then
            echo "::error::Version mismatch: tag is v${VERSION} but package.json has v${PKG_VERSION}"
            exit 1
          fi
          echo "Version validated: v${VERSION}"

      - name: Install dependencies
        if: steps.cmds.outputs.install != ''
        working-directory: ${{ inputs.workingDirectory }}
        run: ${{ steps.cmds.outputs.install }}

      - name: Build
        if: steps.cmds.outputs.build != ''
        working-directory: ${{ inputs.workingDirectory }}
        run: ${{ steps.cmds.outputs.build }}

      - name: Update npm
        if: inputs.packageManager != 'deno' && (inputs.updateNpm || inputs.trustedPublishing)
        run: npm install -g npm@latest

      - name: Validate NPM_TOKEN
        if: inputs.packageManager != 'deno' && !inputs.trustedPublishing
        shell: bash
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [[ -z "${NPM_TOKEN}" ]]; then
            echo "::error::Missing required secret NPM_TOKEN for npm publish"
            exit 1
          fi

      - name: Publish (npm token)
        if: inputs.packageManager != 'deno' && !inputs.trustedPublishing
        working-directory: ${{ inputs.workingDirectory }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: ${{ steps.cmds.outputs.publish }}

      - name: Publish (trusted publishing)
        if: inputs.packageManager != 'deno' && inputs.trustedPublishing
        working-directory: ${{ inputs.workingDirectory }}
        run: ${{ steps.cmds.outputs.publish }}

      - name: Publish (deno)
        if: inputs.packageManager == 'deno'
        working-directory: ${{ inputs.workingDirectory }}
        run: ${{ steps.cmds.outputs.publish }}

      - name: Generate changelog and create release
        if: steps.cmds.outputs.changelog != ''
        working-directory: ${{ inputs.workingDirectory }}
        run: ${{ steps.cmds.outputs.changelog }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
